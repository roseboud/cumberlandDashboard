<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cumberland County Flood Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="styles/map.css" />
</head>
<body>
<!-- Mobile Menu Toggle Button -->
<button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Open sidebar menu">
    <svg id="menu-icon-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
    <svg id="menu-icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
</button>

<!-- Sidebar Overlay Backdrop -->
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<div class="dashboard-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="header-brand">
                <div class="header-logo">
                    <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="36" height="36" rx="8" fill="rgba(255,255,255,0.15)"/>
                        <path d="M8 22c2-3 4-5 7-5s5 4 7 4 4-3 6-5" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                        <path d="M8 26c2-3 4-5 7-5s5 4 7 4 4-3 6-5" stroke="#93c5fd" stroke-width="2" stroke-linecap="round" fill="none" opacity="0.6"/>
                        <path d="M18 8v6M15 11l3 3 3-3" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>Cumberland County</h1>
                    <div class="subtitle">Flood Risk Dashboard &mdash; Chignecto Isthmus</div>
                </div>
            </div>
            <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">
                <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>

        <!-- Flood Level Slider -->
        <div class="sidebar-section">
            <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 15c2-3 4-5 7-5s5 4 7 4 4-3 6-5"/><path d="M2 19c2-3 4-5 7-5s5 4 7 4 4-3 6-5"/></svg>
                <h2>Flood Simulation</h2>
            </div>
            <div class="flood-slider-container">
                <div class="slider-display">
                    <span class="level-label">Water Level</span>
                    <span><span class="level-value" id="flood-level-display">0.0</span><span class="level-unit">m</span></span>
                </div>
                <input type="range" class="flood-slider" id="flood-slider" min="0" max="11" step="0.1" value="0">
                <div class="slider-ticks">
                    <!-- major ticks every metre; decimals will interpolate visually -->
                    <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span><span>11</span>
                </div>
                <div class="slider-side-toggle">
                    <button class="side-btn active" id="btn-both" data-side="both">Both Sides</button>
                    <button class="side-btn" id="btn-fundy" data-side="fundy">Bay of Fundy</button>
                    <button class="side-btn" id="btn-north" data-side="north">Northumberland</button>
                </div>
            </div>
        </div>

        <!-- Tide Stations -->
        <div class="sidebar-section">
            <div class="section-header" id="toggle-tides">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                <h2>Live Tide Stations</h2>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </div>
            <div id="tides-content">
                <div class="tide-widget" id="tide-saintjohn">
                    <div class="tide-station-name"><span class="station-dot"></span> Saint John, NB (Station 00065)</div>
                    <div class="tide-level-display">
                        <span class="tide-level-value" id="tide-value-sj"><span class="loading-spinner"></span></span>
                        <span class="tide-level-unit">metres (CD)</span>
                    </div>
                    <div class="tide-timestamp" id="tide-time-sj">Fetching data...</div>
                    <span class="tide-status normal" id="tide-status-sj">LOADING</span>
                    <div class="tide-refresh-note">Auto-refresh every 5 min</div>
                </div>
                <div class="tide-widget" id="tide-charlottetown">
                    <div class="tide-station-name"><span class="station-dot"></span> Charlottetown, PE (Station 00612)</div>
                    <div class="tide-level-display">
                        <span class="tide-level-value" id="tide-value-ch"><span class="loading-spinner"></span></span>
                        <span class="tide-level-unit">metres (CD)</span>
                    </div>
                    <div class="tide-timestamp" id="tide-time-ch">Fetching data...</div>
                    <span class="tide-status normal" id="tide-status-ch">LOADING</span>
                    <div class="tide-refresh-note">Auto-refresh every 5 min</div>
                </div>
                <div class="tide-widget" id="tide-caribou">
                    <div class="tide-station-name"><span class="station-dot"></span> Caribou, NS (Station 00490)</div>
                    <div class="tide-level-display">
                        <span class="tide-level-value" id="tide-value-cb"><span class="loading-spinner"></span></span>
                        <span class="tide-level-unit">metres (CD)</span>
                    </div>
                    <div class="tide-timestamp" id="tide-time-cb">Fetching data...</div>
                    <span class="tide-status normal" id="tide-status-cb">LOADING</span>
                    <div class="tide-refresh-note">Auto-refresh every 5 min</div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="sidebar-section">
            <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                <h2>Dashboard Summary</h2>
            </div>
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-stations">3</div>
                    <div class="kpi-label">Tide Stations</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-flood-level">0m</div>
                    <div class="kpi-label">Sim. Water Level</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-infra">--</div>
                    <div class="kpi-label">Infrastructure</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-latency">&mdash;</div>
                    <div class="kpi-label">Data Latency</div>
                </div>
            </div>
        </div>

        <!-- Map Layers -->
        <div class="sidebar-section">
            <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                <h2>Map Layers</h2>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="layer-flood" checked>
                <span class="layer-color-swatch" style="background: rgba(37, 99, 235, 0.5);"></span>
                <label for="layer-flood">Flood Inundation</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="layer-roads" checked>
                <span class="layer-color-swatch" style="background: #e67e22;"></span>
                <label for="layer-roads">Road Network</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="layer-infra" checked>
                <span class="layer-color-swatch" style="background: #c0392b;"></span>
                <label for="layer-infra">Critical Infrastructure</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="layer-tides" checked>
                <span class="layer-color-swatch" style="background: #2980b9;"></span>
                <label for="layer-tides">Tide Station Markers</label>
            </div>
        </div>

        <!-- Legend -->
        <div class="sidebar-section">
            <div class="section-header" id="toggle-legend">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                <h2>Legend</h2>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </div>
            <div id="legend-content">
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-area" style="background: rgba(37, 99, 235, 0.35);"></div>
                        <span>Flood Inundation Zone</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #c0392b;"></div>
                        <span>Trunk / Motorway</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #e67e22;"></div>
                        <span>Primary Highway</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #f39c12;"></div>
                        <span>Secondary Highway</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #c0392b;"></div>
                        <span>Fire Station / Emergency</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #27ae60;"></div>
                        <span>Hospital / Healthcare</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #2980b9;"></div>
                        <span>Police / Government</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #2980b9; border: 2px solid #fff;"></div>
                        <span>Tide Monitoring Station</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="sidebar-section">
            <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <h2>Add Custom Layer</h2>
            </div>
            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <p>Drop file here or click to browse</p>
                <div class="upload-formats">Supported: .geojson, .json, .csv</div>
                <input type="file" id="file-input" accept=".json,.geojson,.csv" />
            </div>
            <div class="user-layers-list" id="user-layers-list"></div>
        </div>

        <!-- Footer -->
        <div class="sidebar-footer">
            <strong>Data Sources:</strong> CHS/DFO-MPO (Tides), OpenStreetMap (Roads &amp; Infrastructure), LiDAR-derived flood inundation models.<br>
            <strong>Project:</strong> INFT3000 Capstone &mdash; Cumberland County Flood Risk Assessment.<br>
            <strong>Projection:</strong> NAD83(CSRS)v6 UTM Zone 20N &rarr; WGS84
        </div>
    </aside>

    <!-- MAP AREA -->
    <div class="map-area">
        <div id="map"></div>
        <div class="loading-overlay" id="loading-overlay">
            <span class="loading-spinner"></span>
            <span>Loading flood data...</span>
        </div>
        <div class="map-info-box" id="map-info-box">
            <h3>Cursor Position</h3>
            <div class="info-row">
                <span class="info-label">Lat:</span>
                <span class="info-value" id="cursor-lat">&mdash;</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lng:</span>
                <span class="info-value" id="cursor-lng">&mdash;</span>
            </div>
            <div class="info-row">
                <span class="info-label">Zoom:</span>
                <span class="info-value" id="cursor-zoom">&mdash;</span>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
// ============================================
// CUMBERLAND COUNTY FLOOD DASHBOARD
// ============================================

// ---------- THEME TOGGLE ----------
(function() {
    var saved = localStorage.getItem('cumberland-theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    updateThemeIcons(saved);
})();

function updateThemeIcons(theme) {
    var lightIcon = document.getElementById('theme-icon-light');
    var darkIcon = document.getElementById('theme-icon-dark');
    if (lightIcon && darkIcon) {
        lightIcon.style.display = theme === 'light' ? 'block' : 'none';
        darkIcon.style.display = theme === 'dark' ? 'block' : 'none';
    }
}

document.getElementById('theme-toggle').addEventListener('click', function() {
    var current = document.documentElement.getAttribute('data-theme') || 'light';
    var next = current === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('cumberland-theme', next);
    updateThemeIcons(next);
});

// ---------- SECTION TOGGLES ----------
function setupToggle(headerId, contentId) {
    var header = document.getElementById(headerId);
    var content = document.getElementById(contentId);
    if (header && content) {
        header.addEventListener('click', function() {
            var isHidden = content.style.display === 'none';
            content.style.display = isHidden ? '' : 'none';
            header.classList.toggle('collapsed', !isHidden);
        });
    }
}
setupToggle('toggle-tides', 'tides-content');
setupToggle('toggle-legend', 'legend-content');

// ---------- MOBILE SIDEBAR TOGGLE ----------
(function() {
    var menuBtn = document.getElementById('mobile-menu-toggle');
    var sidebar = document.getElementById('sidebar');
    var backdrop = document.getElementById('sidebar-backdrop');
    var iconOpen = document.getElementById('menu-icon-open');
    var iconClose = document.getElementById('menu-icon-close');

    function openSidebar() {
        sidebar.classList.add('open');
        backdrop.classList.add('visible');
        document.body.classList.add('sidebar-open');
        iconOpen.style.display = 'none';
        iconClose.style.display = 'block';
        menuBtn.setAttribute('aria-label', 'Close sidebar menu');
    }

    function closeSidebar() {
        sidebar.classList.remove('open');
        backdrop.classList.remove('visible');
        document.body.classList.remove('sidebar-open');
        iconOpen.style.display = 'block';
        iconClose.style.display = 'none';
        menuBtn.setAttribute('aria-label', 'Open sidebar menu');
    }

    if (menuBtn && sidebar && backdrop) {
        menuBtn.addEventListener('click', function() {
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        });

        backdrop.addEventListener('click', closeSidebar);

        // Close sidebar on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                closeSidebar();
            }
        });

        // Close sidebar when window resizes above mobile breakpoint
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && sidebar.classList.contains('open')) {
                closeSidebar();
            }
        });
    }

    // Expose closeSidebar globally so other interactions can use it
    window.closeMobileSidebar = closeSidebar;
})();

// ---------- UTILITIES ----------
function showToast(message, type) {
    type = type || 'info';
    var toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type + ' show';
    setTimeout(function() { toast.className = 'toast'; }, 3500);
}

function formatTimestamp(isoStr) {
    try {
        var d = new Date(isoStr);
        return d.toLocaleString('en-CA', {
            timeZone: 'America/Halifax',
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }) + ' AST';
    } catch (e) { return isoStr; }
}

// ---------- MAP INITIALIZATION ----------
var map = L.map('map', {
    center: [45.75, -64.30],
    zoom: 10,
    zoomControl: true,
    attributionControl: true
});

var osmBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: '&copy; OpenTopoMap'
});

var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; CARTO'
});

var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 18,
    attribution: '&copy; Esri'
});

L.control.layers({
    'Street Map': osmBase,
    'Topographic': topoLayer,
    'Satellite': satelliteLayer,
    'Dark': darkLayer
}, null, { position: 'topleft' }).addTo(map);

L.control.scale({ maxWidth: 200, imperial: false }).addTo(map);

// Cursor position
document.getElementById('cursor-zoom').textContent = map.getZoom();
map.on('mousemove', function(e) {
    document.getElementById('cursor-lat').textContent = e.latlng.lat.toFixed(5);
    document.getElementById('cursor-lng').textContent = e.latlng.lng.toFixed(5);
});
map.on('zoomend', function() {
    document.getElementById('cursor-zoom').textContent = map.getZoom();
});

// ---------- LAYER GROUPS ----------
var floodLayerFundy = L.layerGroup().addTo(map);
var floodLayerNorth = L.layerGroup().addTo(map);
var roadsLayer = L.layerGroup().addTo(map);
var infraLayer = L.layerGroup().addTo(map);
var tideMarkersLayer = L.layerGroup().addTo(map);
var userLayers = {};
var userLayerCounter = 0;

// ---------- FLOOD LAYER CACHE ----------
var floodCache = {};
var currentFloodLevel = 0;
var currentSide = 'both';

// ---------- TIDE STATIONS ----------
var TIDE_STATIONS = [
    {
        id: '5cebf1df3d0f4a073c4bbc24',
        name: 'Saint John, NB',
        lat: 45.2517, lng: -66.0633,
        valueEl: 'tide-value-sj', timeEl: 'tide-time-sj', statusEl: 'tide-status-sj',
        thresholdElevated: 7.5, thresholdCritical: 8.5
    },
    {
        id: '5cebf1e33d0f4a073c4bc21f',
        name: 'Charlottetown, PE',
        lat: 46.2340, lng: -63.1191,
        valueEl: 'tide-value-ch', timeEl: 'tide-time-ch', statusEl: 'tide-status-ch',
        thresholdElevated: 2.2, thresholdCritical: 2.8
    },
    {
        id: '5cebf1e33d0f4a073c4bc20d',
        name: 'Caribou, NS',
        lat: 45.7700, lng: -62.6783,
        valueEl: 'tide-value-cb', timeEl: 'tide-time-cb', statusEl: 'tide-status-cb',
        thresholdElevated: 2.0, thresholdCritical: 2.6
    }
];

// ---------- TIDE API ----------
async function fetchTideData(station) {
    var now = new Date();
    var oneHourAgo = new Date(now.getTime() - 3600000);
    var from = oneHourAgo.toISOString();
    var to = now.toISOString();
    var observedUrl = 'https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/' + station.id + '/data?time-series-code=wlo&from=' + from + '&to=' + to;
    var predictedUrl = 'https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/' + station.id + '/data?time-series-code=wlp&from=' + from + '&to=' + to;

    var valEl = document.getElementById(station.valueEl);
    var timeEl = document.getElementById(station.timeEl);
    var statusEl = document.getElementById(station.statusEl);

    try {
        var response = await fetch(observedUrl);
        var data = null;
        var dataType = 'Observed';
        if (response.ok) data = await response.json();
        if (!data || data.length === 0) {
            response = await fetch(predictedUrl);
            if (response.ok) { data = await response.json(); dataType = 'Predicted'; }
        }
        if (data && data.length > 0) {
            var latest = data[data.length - 1];
            var waterLevel = parseFloat(latest.value).toFixed(2);
            var timestamp = latest.eventDate || latest.timeStamp;
            valEl.textContent = waterLevel;
            timeEl.textContent = dataType + ' \u2014 ' + formatTimestamp(timestamp);
            var latencyMs = now.getTime() - new Date(timestamp).getTime();
            var latencyMin = Math.round(latencyMs / 60000);
            document.getElementById('kpi-latency').textContent = latencyMin + 'm';
            var level = parseFloat(waterLevel);
            if (level >= station.thresholdCritical) {
                statusEl.textContent = 'CRITICAL'; statusEl.className = 'tide-status critical';
            } else if (level >= station.thresholdElevated) {
                statusEl.textContent = 'ELEVATED'; statusEl.className = 'tide-status elevated';
            } else {
                statusEl.textContent = 'NORMAL'; statusEl.className = 'tide-status normal';
            }
        } else {
            valEl.textContent = 'N/A'; timeEl.textContent = 'No data in last hour';
            statusEl.textContent = 'NO DATA'; statusEl.className = 'tide-status elevated';
        }
    } catch (err) {
        console.error('Tide fetch error for ' + station.name + ':', err);
        valEl.textContent = 'ERR'; timeEl.textContent = 'API unreachable';
        statusEl.textContent = 'OFFLINE'; statusEl.className = 'tide-status critical';
    }
}

async function refreshAllTides() {
    for (var i = 0; i < TIDE_STATIONS.length; i++) {
        await fetchTideData(TIDE_STATIONS[i]);
    }
    showToast('Tide data refreshed', 'success');
}

refreshAllTides();
setInterval(refreshAllTides, 300000);

// ---------- TIDE MARKERS ----------
var tideIcon = L.divIcon({
    html: '<div style="background:#2980b9;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 6px rgba(41,128,185,0.5);"></div>',
    className: '', iconSize: [12, 12], iconAnchor: [6, 6]
});

TIDE_STATIONS.forEach(function(station) {
    var marker = L.marker([station.lat, station.lng], { icon: tideIcon });
    marker.bindPopup(
        '<div class="popup-title">' + station.name + '</div>' +
        '<div class="popup-row"><span class="popup-label">Type:</span><span class="popup-value">CHS Tidal Gauge</span></div>' +
        '<div class="popup-row"><span class="popup-label">Coordinates:</span><span class="popup-value">' + station.lat.toFixed(4) + ', ' + station.lng.toFixed(4) + '</span></div>' +
        '<div class="popup-row"><span class="popup-label">Elevated:</span><span class="popup-value">' + station.thresholdElevated + 'm</span></div>' +
        '<div class="popup-row"><span class="popup-label">Critical:</span><span class="popup-value">' + station.thresholdCritical + 'm</span></div>'
    );
    marker.addTo(tideMarkersLayer);
});

// ---------- FLOOD SLIDER LOGIC ----------
function getFloodStyle(level) {
    var opacity = 0.2 + (level / 11) * 0.35;
    var r = Math.round(30 + (level / 11) * 20);
    var g = Math.round(100 - (level / 11) * 60);
    var b = Math.round(235 - (level / 11) * 50);
    return {
        fillColor: 'rgb(' + r + ',' + g + ',' + b + ')',
        fillOpacity: opacity,
        color: 'rgb(' + Math.max(r-30,0) + ',' + Math.max(g-30,0) + ',' + Math.max(b-30,0) + ')',
        weight: 1.5,
        opacity: 0.7
    };
}

// convert numeric level to underscored label used in filenames
function levelLabel(level) {
    var whole = Math.floor(level);
    var tenths = Math.round((level - whole) * 10);
    return whole + '_' + tenths + 'm';
}

async function loadFloodLayer(side, level) {
    var label = levelLabel(level);
    var key = side + '_' + label;
    if (floodCache[key]) return floodCache[key];

    var url = 'assets/geojson/flood_' + side + '_' + label + '.geojson';
    try {
        var response = await fetch(url);
        if (!response.ok) throw new Error('HTTP ' + response.status);
        var data = await response.json();
        var layer = L.geoJSON(data, {
            style: getFloodStyle(level),
            onEachFeature: function(feature, lyr) {
                lyr.bindPopup(
                    '<div class="popup-title">Flood Inundation Zone</div>' +
                    '<div class="popup-row"><span class="popup-label">Water Level:</span><span class="popup-value">' + level.toFixed(1) + ' m</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Source:</span><span class="popup-value">' + (side === 'fundy' ? 'Bay of Fundy' : 'Northumberland Strait') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Data:</span><span class="popup-value">LiDAR DEM derived</span></div>'
                );
            }
        });
        floodCache[key] = layer;
        return layer;
    } catch (err) {
        console.error('Failed to load flood layer:', url, err);
        return null;
    }
}

async function updateFloodDisplay(level) {
    var overlay = document.getElementById('loading-overlay');
    overlay.classList.add('visible');

    floodLayerFundy.clearLayers();
    floodLayerNorth.clearLayers();

    document.getElementById('flood-level-display').textContent = level.toFixed(1);
    document.getElementById('kpi-flood-level').textContent = level.toFixed(1) + 'm';

    var loadPromises = [];

    if (currentSide === 'both' || currentSide === 'fundy') {
        loadPromises.push(
            loadFloodLayer('fundy', level).then(function(layer) {
                if (layer) floodLayerFundy.addLayer(layer);
            })
        );
    }

    if (currentSide === 'both' || currentSide === 'north') {
        loadPromises.push(
            loadFloodLayer('north', level).then(function(layer) {
                if (layer) floodLayerNorth.addLayer(layer);
            })
        );
    }

    await Promise.all(loadPromises);
    overlay.classList.remove('visible');
}

// Slider event
var sliderTimeout = null;
document.getElementById('flood-slider').addEventListener('input', function(e) {
    var level = parseFloat(e.target.value);
    // round to one decimal to avoid floating-point noise
    level = Math.round(level * 10) / 10;
    currentFloodLevel = level;
    document.getElementById('flood-level-display').textContent = level.toFixed(1);
    document.getElementById('kpi-flood-level').textContent = level.toFixed(1) + 'm';

    if (sliderTimeout) clearTimeout(sliderTimeout);
    sliderTimeout = setTimeout(function() {
        updateFloodDisplay(level);
    }, 200);
});

// Side toggle buttons
document.querySelectorAll('.side-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.side-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        currentSide = this.getAttribute('data-side');
        updateFloodDisplay(currentFloodLevel);
    });
});

// ---------- ROAD NETWORK (Real OSM Data) ----------
fetch('assets/geojson/roads_cumberland.geojson')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        L.geoJSON(data, {
            style: function(feature) {
                var hw = feature.properties.highway;
                var color = '#f39c12';
                var weight = 2;
                var opacity = 0.7;
                if (hw === 'motorway' || hw === 'motorway_link') {
                    color = '#8e44ad'; weight = 4; opacity = 0.85;
                } else if (hw === 'trunk' || hw === 'trunk_link') {
                    color = '#c0392b'; weight = 3.5; opacity = 0.85;
                } else if (hw === 'primary') {
                    color = '#e67e22'; weight = 3; opacity = 0.8;
                } else if (hw === 'secondary') {
                    color = '#f39c12'; weight = 2.5; opacity = 0.75;
                }
                return { color: color, weight: weight, opacity: opacity };
            },
            onEachFeature: function(feature, layer) {
                var p = feature.properties;
                var name = p.name || 'Unnamed';
                var ref = p.ref ? ' (' + p.ref + ')' : '';
                layer.bindPopup(
                    '<div class="popup-title">' + name + ref + '</div>' +
                    '<div class="popup-row"><span class="popup-label">Classification:</span><span class="popup-value">' + (p.highway || 'N/A') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Surface:</span><span class="popup-value">' + (p.surface || 'paved') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Lanes:</span><span class="popup-value">' + (p.lanes || 'N/A') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Source:</span><span class="popup-value">OpenStreetMap</span></div>'
                );
            }
        }).addTo(roadsLayer);
        showToast('Road network loaded (' + data.features.length + ' segments)', 'info');
    })
    .catch(function(err) { console.error('Road network error:', err); });

// ---------- CRITICAL INFRASTRUCTURE (Real OSM Data) ----------
function getInfraStyle(amenity) {
    if (amenity === 'fire_station') return { color: '#c0392b', label: 'Fire Station' };
    if (amenity === 'hospital' || amenity === 'clinic') return { color: '#27ae60', label: 'Healthcare' };
    if (amenity === 'police') return { color: '#2980b9', label: 'Police' };
    if (amenity === 'townhall') return { color: '#8e44ad', label: 'Town Hall' };
    if (amenity === 'community_centre') return { color: '#e67e22', label: 'Community Centre' };
    return { color: '#7f8c8d', label: amenity || 'Facility' };
}

fetch('assets/geojson/infrastructure_cumberland.geojson')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var count = 0;
        L.geoJSON(data, {
            pointToLayer: function(feature, latlng) {
                var amenity = feature.properties.amenity || feature.properties.healthcare || feature.properties.emergency || '';
                var style = getInfraStyle(amenity);
                count++;
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: style.color,
                    color: '#ffffff',
                    weight: 2,
                    fillOpacity: 0.9
                });
            },
            onEachFeature: function(feature, layer) {
                var p = feature.properties;
                var amenity = p.amenity || p.healthcare || p.emergency || '';
                var style = getInfraStyle(amenity);
                var name = p.name || style.label;
                var addr = '';
                if (p['addr:street']) addr = (p['addr:housenumber'] || '') + ' ' + p['addr:street'];
                layer.bindPopup(
                    '<div class="popup-title">' + name + '</div>' +
                    '<div class="popup-row"><span class="popup-label">Type:</span><span class="popup-value">' + style.label + '</span></div>' +
                    (addr ? '<div class="popup-row"><span class="popup-label">Address:</span><span class="popup-value">' + addr.trim() + '</span></div>' : '') +
                    '<div class="popup-row"><span class="popup-label">Source:</span><span class="popup-value">OpenStreetMap</span></div>'
                );
            }
        }).addTo(infraLayer);
        document.getElementById('kpi-infra').textContent = count;
        showToast('Infrastructure loaded (' + count + ' facilities)', 'info');
    })
    .catch(function(err) { console.error('Infrastructure error:', err); });

// ---------- SIDEBAR LAYER TOGGLES ----------
document.getElementById('layer-flood').addEventListener('change', function(e) {
    if (e.target.checked) { map.addLayer(floodLayerFundy); map.addLayer(floodLayerNorth); }
    else { map.removeLayer(floodLayerFundy); map.removeLayer(floodLayerNorth); }
});
document.getElementById('layer-roads').addEventListener('change', function(e) {
    if (e.target.checked) map.addLayer(roadsLayer); else map.removeLayer(roadsLayer);
});
document.getElementById('layer-infra').addEventListener('change', function(e) {
    if (e.target.checked) map.addLayer(infraLayer); else map.removeLayer(infraLayer);
});
document.getElementById('layer-tides').addEventListener('change', function(e) {
    if (e.target.checked) map.addLayer(tideMarkersLayer); else map.removeLayer(tideMarkersLayer);
});

// ---------- FILE UPLOAD ----------
var uploadZone = document.getElementById('upload-zone');
var fileInput = document.getElementById('file-input');
var userLayersList = document.getElementById('user-layers-list');

uploadZone.addEventListener('click', function() { fileInput.click(); });
uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault(); uploadZone.classList.add('drag-over');
});
uploadZone.addEventListener('dragleave', function() {
    uploadZone.classList.remove('drag-over');
});
uploadZone.addEventListener('drop', function(e) {
    e.preventDefault(); uploadZone.classList.remove('drag-over');
    if (e.dataTransfer.files.length > 0) processUploadedFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) { processUploadedFile(e.target.files[0]); fileInput.value = ''; }
});

function processUploadedFile(file) {
    var fileName = file.name.toLowerCase();
    var reader = new FileReader();
    reader.onload = function(e) {
        var content = e.target.result;
        try {
            if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                addUserGeoJSONLayer(file.name, JSON.parse(content));
            } else if (fileName.endsWith('.csv')) {
                addUserCSVLayer(file.name, content);
            } else {
                showToast('Unsupported format: ' + fileName, 'error');
            }
        } catch (err) {
            showToast('Error parsing file: ' + err.message, 'error');
        }
    };
    reader.readAsText(file);
}

function addUserGeoJSONLayer(name, geoData) {
    var layerId = 'user-layer-' + (++userLayerCounter);
    var layer = L.geoJSON(geoData, {
        style: { fillColor: '#8b5cf6', fillOpacity: 0.3, color: '#6d28d9', weight: 2 },
        pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 6, fillColor: '#8b5cf6', color: '#6d28d9', weight: 2, fillOpacity: 0.7
            });
        },
        onEachFeature: function(feature, layer) {
            if (feature.properties) {
                var html = '<div class="popup-title">Custom Layer Feature</div>';
                for (var key in feature.properties) {
                    html += '<div class="popup-row"><span class="popup-label">' + key + ':</span><span class="popup-value">' + feature.properties[key] + '</span></div>';
                }
                layer.bindPopup(html);
            }
        }
    }).addTo(map);
    userLayers[layerId] = layer;
    addUserLayerUI(layerId, name);
    map.fitBounds(layer.getBounds(), { padding: [30, 30] });
    showToast('Layer loaded: ' + name, 'success');
}

function addUserCSVLayer(name, csvText) {
    var lines = csvText.trim().split('\n');
    if (lines.length < 2) { showToast('CSV file appears empty', 'error'); return; }
    var headers = lines[0].split(',').map(function(h) { return h.trim().toLowerCase(); });
    var latIdx = headers.findIndex(function(h) { return h === 'lat' || h === 'latitude'; });
    var lngIdx = headers.findIndex(function(h) { return h === 'lng' || h === 'lon' || h === 'long' || h === 'longitude'; });
    if (latIdx === -1 || lngIdx === -1) {
        showToast('CSV must have Lat and Lng columns', 'error'); return;
    }
    var layerId = 'user-layer-' + (++userLayerCounter);
    var layerGroup = L.layerGroup();
    var count = 0;
    for (var i = 1; i < lines.length; i++) {
        var cols = lines[i].split(',').map(function(c) { return c.trim(); });
        var lat = parseFloat(cols[latIdx]);
        var lng = parseFloat(cols[lngIdx]);
        if (!isNaN(lat) && !isNaN(lng)) {
            var marker = L.circleMarker([lat, lng], {
                radius: 5, fillColor: '#8b5cf6', color: '#6d28d9', weight: 2, fillOpacity: 0.7
            });
            var popupHtml = '<div class="popup-title">CSV Row ' + i + '</div>';
            headers.forEach(function(h, idx) {
                popupHtml += '<div class="popup-row"><span class="popup-label">' + h + ':</span><span class="popup-value">' + (cols[idx] || '') + '</span></div>';
            });
            marker.bindPopup(popupHtml);
            marker.addTo(layerGroup);
            count++;
        }
    }
    if (count === 0) { showToast('No valid coordinates in CSV', 'error'); return; }
    layerGroup.addTo(map);
    userLayers[layerId] = layerGroup;
    addUserLayerUI(layerId, name + ' (' + count + ' pts)');
    showToast('CSV loaded: ' + count + ' points', 'success');
}

function addUserLayerUI(layerId, name) {
    var item = document.createElement('div');
    item.className = 'user-layer-item';
    item.id = layerId + '-ui';
    item.innerHTML = '<span class="layer-name" title="' + name + '">' + name + '</span>' +
                     '<button class="remove-layer" data-layer-id="' + layerId + '">&times;</button>';
    userLayersList.appendChild(item);
    item.querySelector('.remove-layer').addEventListener('click', function() {
        var lid = this.getAttribute('data-layer-id');
        if (userLayers[lid]) { map.removeLayer(userLayers[lid]); delete userLayers[lid]; }
        var uiEl = document.getElementById(lid + '-ui');
        if (uiEl) uiEl.remove();
        showToast('Layer removed', 'info');
    });
}

// ---------- INITIAL FLOOD LOAD ----------
updateFloodDisplay(0);

// ---------- MAP RESIZE ON SIDEBAR TOGGLE ----------
// Leaflet needs invalidateSize when layout changes
(function() {
    var sidebar = document.getElementById('sidebar');
    if (sidebar) {
        var observer = new MutationObserver(function() {
            setTimeout(function() { map.invalidateSize(); }, 350);
        });
        observer.observe(sidebar, { attributes: true, attributeFilter: ['class'] });
    }
    // Also handle window resize
    window.addEventListener('resize', function() {
        map.invalidateSize();
    });
})();

console.log('Cumberland County Flood Dashboard initialized');
console.log('Tide stations: Saint John, Charlottetown, Caribou');
console.log('Flood data: FundySide + NorthSide (0-11m, 1m increments)');
console.log('Roads & Infrastructure: OpenStreetMap');

</script>
</body>
</html>
