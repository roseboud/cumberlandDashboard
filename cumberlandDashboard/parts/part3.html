
    <!-- MAP AREA -->
    <div class="map-area">
        <div id="map"></div>
        <div class="loading-overlay" id="loading-overlay">
            <span class="loading-spinner"></span>
            <span>Loading flood data...</span>
        </div>
        <div class="map-info-box" id="map-info-box">
            <h3>Cursor Position</h3>
            <div class="info-row">
                <span class="info-label">Lat:</span>
                <span class="info-value" id="cursor-lat">&mdash;</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lng:</span>
                <span class="info-value" id="cursor-lng">&mdash;</span>
            </div>
            <div class="info-row">
                <span class="info-label">Zoom:</span>
                <span class="info-value" id="cursor-zoom">&mdash;</span>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
// ============================================
// CUMBERLAND COUNTY FLOOD DASHBOARD
// ============================================

// ---------- THEME TOGGLE ----------
(function() {
    var saved = localStorage.getItem('cumberland-theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    updateThemeIcons(saved);
})();

function updateThemeIcons(theme) {
    var lightIcon = document.getElementById('theme-icon-light');
    var darkIcon = document.getElementById('theme-icon-dark');
    if (lightIcon && darkIcon) {
        lightIcon.style.display = theme === 'light' ? 'block' : 'none';
        darkIcon.style.display = theme === 'dark' ? 'block' : 'none';
    }
}

document.getElementById('theme-toggle').addEventListener('click', function() {
    var current = document.documentElement.getAttribute('data-theme') || 'light';
    var next = current === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('cumberland-theme', next);
    updateThemeIcons(next);
});

// ---------- SECTION TOGGLES ----------
function setupToggle(headerId, contentId) {
    var header = document.getElementById(headerId);
    var content = document.getElementById(contentId);
    if (header && content) {
        header.addEventListener('click', function() {
            var isHidden = content.style.display === 'none';
            content.style.display = isHidden ? '' : 'none';
            header.classList.toggle('collapsed', !isHidden);
        });
    }
}
setupToggle('toggle-tides', 'tides-content');
setupToggle('toggle-legend', 'legend-content');

// ---------- UTILITIES ----------
function showToast(message, type) {
    type = type || 'info';
    var toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type + ' show';
    setTimeout(function() { toast.className = 'toast'; }, 3500);
}

function formatTimestamp(isoStr) {
    try {
        var d = new Date(isoStr);
        return d.toLocaleString('en-CA', {
            timeZone: 'America/Halifax',
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }) + ' AST';
    } catch (e) { return isoStr; }
}

// ---------- MAP INITIALIZATION ----------
var map = L.map('map', {
    center: [45.75, -64.30],
    zoom: 10,
    zoomControl: true,
    attributionControl: true
});

var osmBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: '&copy; OpenTopoMap'
});

var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; CARTO'
});

var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 18,
    attribution: '&copy; Esri'
});

L.control.layers({
    'Street Map': osmBase,
    'Topographic': topoLayer,
    'Satellite': satelliteLayer,
    'Dark': darkLayer
}, null, { position: 'topleft' }).addTo(map);

L.control.scale({ maxWidth: 200, imperial: false }).addTo(map);

// Cursor position
document.getElementById('cursor-zoom').textContent = map.getZoom();
map.on('mousemove', function(e) {
    document.getElementById('cursor-lat').textContent = e.latlng.lat.toFixed(5);
    document.getElementById('cursor-lng').textContent = e.latlng.lng.toFixed(5);
});
map.on('zoomend', function() {
    document.getElementById('cursor-zoom').textContent = map.getZoom();
});

// ---------- LAYER GROUPS ----------
var floodLayerFundy = L.layerGroup().addTo(map);
var floodLayerNorth = L.layerGroup().addTo(map);
var roadsLayer = L.layerGroup().addTo(map);
var infraLayer = L.layerGroup().addTo(map);
var tideMarkersLayer = L.layerGroup().addTo(map);
var userLayers = {};
var userLayerCounter = 0;

// ---------- FLOOD LAYER CACHE ----------
var floodCache = {};
var currentFloodLevel = 0;
var currentSide = 'both';

// ---------- TIDE STATIONS ----------
var TIDE_STATIONS = [
    {
        id: '5cebf1df3d0f4a073c4bbc24',
        name: 'Saint John, NB',
        lat: 45.2517, lng: -66.0633,
        valueEl: 'tide-value-sj', timeEl: 'tide-time-sj', statusEl: 'tide-status-sj',
        thresholdElevated: 7.5, thresholdCritical: 8.5
    },
    {
        id: '5cebf1e33d0f4a073c4bc21f',
        name: 'Charlottetown, PE',
        lat: 46.2340, lng: -63.1191,
        valueEl: 'tide-value-ch', timeEl: 'tide-time-ch', statusEl: 'tide-status-ch',
        thresholdElevated: 2.2, thresholdCritical: 2.8
    },
    {
        id: '5cebf1e33d0f4a073c4bc20d',
        name: 'Caribou, NS',
        lat: 45.7700, lng: -62.6783,
        valueEl: 'tide-value-cb', timeEl: 'tide-time-cb', statusEl: 'tide-status-cb',
        thresholdElevated: 2.0, thresholdCritical: 2.6
    }
];

// ---------- TIDE API ----------
async function fetchTideData(station) {
    var now = new Date();
    var oneHourAgo = new Date(now.getTime() - 3600000);
    var from = oneHourAgo.toISOString();
    var to = now.toISOString();
    var observedUrl = 'https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/' + station.id + '/data?time-series-code=wlo&from=' + from + '&to=' + to;
    var predictedUrl = 'https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/' + station.id + '/data?time-series-code=wlp&from=' + from + '&to=' + to;

    var valEl = document.getElementById(station.valueEl);
    var timeEl = document.getElementById(station.timeEl);
    var statusEl = document.getElementById(station.statusEl);

    try {
        var response = await fetch(observedUrl);
        var data = null;
        var dataType = 'Observed';
        if (response.ok) data = await response.json();
        if (!data || data.length === 0) {
            response = await fetch(predictedUrl);
            if (response.ok) { data = await response.json(); dataType = 'Predicted'; }
        }
        if (data && data.length > 0) {
            var latest = data[data.length - 1];
            var waterLevel = parseFloat(latest.value).toFixed(2);
            var timestamp = latest.eventDate || latest.timeStamp;
            valEl.textContent = waterLevel;
            timeEl.textContent = dataType + ' \u2014 ' + formatTimestamp(timestamp);
            var latencyMs = now.getTime() - new Date(timestamp).getTime();
            var latencyMin = Math.round(latencyMs / 60000);
            document.getElementById('kpi-latency').textContent = latencyMin + 'm';
            var level = parseFloat(waterLevel);
            if (level >= station.thresholdCritical) {
                statusEl.textContent = 'CRITICAL'; statusEl.className = 'tide-status critical';
            } else if (level >= station.thresholdElevated) {
                statusEl.textContent = 'ELEVATED'; statusEl.className = 'tide-status elevated';
            } else {
                statusEl.textContent = 'NORMAL'; statusEl.className = 'tide-status normal';
            }
        } else {
            valEl.textContent = 'N/A'; timeEl.textContent = 'No data in last hour';
            statusEl.textContent = 'NO DATA'; statusEl.className = 'tide-status elevated';
        }
    } catch (err) {
        console.error('Tide fetch error for ' + station.name + ':', err);
        valEl.textContent = 'ERR'; timeEl.textContent = 'API unreachable';
        statusEl.textContent = 'OFFLINE'; statusEl.className = 'tide-status critical';
    }
}

async function refreshAllTides() {
    for (var i = 0; i < TIDE_STATIONS.length; i++) {
        await fetchTideData(TIDE_STATIONS[i]);
    }
    showToast('Tide data refreshed', 'success');
}

refreshAllTides();
setInterval(refreshAllTides, 300000);

// ---------- TIDE MARKERS ----------
var tideIcon = L.divIcon({
    html: '<div style="background:#2980b9;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 6px rgba(41,128,185,0.5);"></div>',
    className: '', iconSize: [12, 12], iconAnchor: [6, 6]
});

TIDE_STATIONS.forEach(function(station) {
    var marker = L.marker([station.lat, station.lng], { icon: tideIcon });
    marker.bindPopup(
        '<div class="popup-title">' + station.name + '</div>' +
        '<div class="popup-row"><span class="popup-label">Type:</span><span class="popup-value">CHS Tidal Gauge</span></div>' +
        '<div class="popup-row"><span class="popup-label">Coordinates:</span><span class="popup-value">' + station.lat.toFixed(4) + ', ' + station.lng.toFixed(4) + '</span></div>' +
        '<div class="popup-row"><span class="popup-label">Elevated:</span><span class="popup-value">' + station.thresholdElevated + 'm</span></div>' +
        '<div class="popup-row"><span class="popup-label">Critical:</span><span class="popup-value">' + station.thresholdCritical + 'm</span></div>'
    );
    marker.addTo(tideMarkersLayer);
});
