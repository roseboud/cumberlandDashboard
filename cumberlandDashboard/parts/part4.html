
// ---------- FLOOD SLIDER LOGIC ----------
function getFloodStyle(level) {
    var opacity = 0.2 + (level / 11) * 0.35;
    var r = Math.round(30 + (level / 11) * 20);
    var g = Math.round(100 - (level / 11) * 60);
    var b = Math.round(235 - (level / 11) * 50);
    return {
        fillColor: 'rgb(' + r + ',' + g + ',' + b + ')',
        fillOpacity: opacity,
        color: 'rgb(' + Math.max(r-30,0) + ',' + Math.max(g-30,0) + ',' + Math.max(b-30,0) + ')',
        weight: 1.5,
        opacity: 0.7
    };
}

async function loadFloodLayer(side, level) {
    var key = side + '_' + level + '_0m';
    if (floodCache[key]) return floodCache[key];

    var url = 'assets/geojson/flood_' + side + '_' + level + '_0m.geojson';
    try {
        var response = await fetch(url);
        if (!response.ok) throw new Error('HTTP ' + response.status);
        var data = await response.json();
        var layer = L.geoJSON(data, {
            style: getFloodStyle(level),
            onEachFeature: function(feature, lyr) {
                lyr.bindPopup(
                    '<div class="popup-title">Flood Inundation Zone</div>' +
                    '<div class="popup-row"><span class="popup-label">Water Level:</span><span class="popup-value">' + level + '.0 m</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Source:</span><span class="popup-value">' + (side === 'fundy' ? 'Bay of Fundy' : 'Northumberland Strait') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Data:</span><span class="popup-value">LiDAR DEM derived</span></div>'
                );
            }
        });
        floodCache[key] = layer;
        return layer;
    } catch (err) {
        console.error('Failed to load flood layer:', url, err);
        return null;
    }
}

async function updateFloodDisplay(level) {
    var overlay = document.getElementById('loading-overlay');
    overlay.classList.add('visible');

    floodLayerFundy.clearLayers();
    floodLayerNorth.clearLayers();

    document.getElementById('flood-level-display').textContent = level + '.0';
    document.getElementById('kpi-flood-level').textContent = level + 'm';

    var loadPromises = [];

    if (currentSide === 'both' || currentSide === 'fundy') {
        loadPromises.push(
            loadFloodLayer('fundy', level).then(function(layer) {
                if (layer) floodLayerFundy.addLayer(layer);
            })
        );
    }

    if (currentSide === 'both' || currentSide === 'north') {
        loadPromises.push(
            loadFloodLayer('north', level).then(function(layer) {
                if (layer) floodLayerNorth.addLayer(layer);
            })
        );
    }

    await Promise.all(loadPromises);
    overlay.classList.remove('visible');
}

// Slider event
var sliderTimeout = null;
document.getElementById('flood-slider').addEventListener('input', function(e) {
    var level = parseInt(e.target.value);
    currentFloodLevel = level;
    document.getElementById('flood-level-display').textContent = level + '.0';
    document.getElementById('kpi-flood-level').textContent = level + 'm';

    if (sliderTimeout) clearTimeout(sliderTimeout);
    sliderTimeout = setTimeout(function() {
        updateFloodDisplay(level);
    }, 200);
});

// Side toggle buttons
document.querySelectorAll('.side-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.side-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        currentSide = this.getAttribute('data-side');
        updateFloodDisplay(currentFloodLevel);
    });
});

// ---------- ROAD NETWORK (Real OSM Data) ----------
fetch('assets/geojson/roads_cumberland.geojson')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        L.geoJSON(data, {
            style: function(feature) {
                var hw = feature.properties.highway;
                var color = '#f39c12';
                var weight = 2;
                var opacity = 0.7;
                if (hw === 'motorway' || hw === 'motorway_link') {
                    color = '#8e44ad'; weight = 4; opacity = 0.85;
                } else if (hw === 'trunk' || hw === 'trunk_link') {
                    color = '#c0392b'; weight = 3.5; opacity = 0.85;
                } else if (hw === 'primary') {
                    color = '#e67e22'; weight = 3; opacity = 0.8;
                } else if (hw === 'secondary') {
                    color = '#f39c12'; weight = 2.5; opacity = 0.75;
                }
                return { color: color, weight: weight, opacity: opacity };
            },
            onEachFeature: function(feature, layer) {
                var p = feature.properties;
                var name = p.name || 'Unnamed';
                var ref = p.ref ? ' (' + p.ref + ')' : '';
                layer.bindPopup(
                    '<div class="popup-title">' + name + ref + '</div>' +
                    '<div class="popup-row"><span class="popup-label">Classification:</span><span class="popup-value">' + (p.highway || 'N/A') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Surface:</span><span class="popup-value">' + (p.surface || 'paved') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Lanes:</span><span class="popup-value">' + (p.lanes || 'N/A') + '</span></div>' +
                    '<div class="popup-row"><span class="popup-label">Source:</span><span class="popup-value">OpenStreetMap</span></div>'
                );
            }
        }).addTo(roadsLayer);
        showToast('Road network loaded (' + data.features.length + ' segments)', 'info');
    })
    .catch(function(err) { console.error('Road network error:', err); });

// ---------- CRITICAL INFRASTRUCTURE (Real OSM Data) ----------
function getInfraStyle(amenity) {
    if (amenity === 'fire_station') return { color: '#c0392b', label: 'Fire Station' };
    if (amenity === 'hospital' || amenity === 'clinic') return { color: '#27ae60', label: 'Healthcare' };
    if (amenity === 'police') return { color: '#2980b9', label: 'Police' };
    if (amenity === 'townhall') return { color: '#8e44ad', label: 'Town Hall' };
    if (amenity === 'community_centre') return { color: '#e67e22', label: 'Community Centre' };
    return { color: '#7f8c8d', label: amenity || 'Facility' };
}

fetch('assets/geojson/infrastructure_cumberland.geojson')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var count = 0;
        L.geoJSON(data, {
            pointToLayer: function(feature, latlng) {
                var amenity = feature.properties.amenity || feature.properties.healthcare || feature.properties.emergency || '';
                var style = getInfraStyle(amenity);
                count++;
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: style.color,
                    color: '#ffffff',
                    weight: 2,
                    fillOpacity: 0.9
                });
            },
            onEachFeature: function(feature, layer) {
                var p = feature.properties;
                var amenity = p.amenity || p.healthcare || p.emergency || '';
                var style = getInfraStyle(amenity);
                var name = p.name || style.label;
                var addr = '';
                if (p['addr:street']) addr = (p['addr:housenumber'] || '') + ' ' + p['addr:street'];
                layer.bindPopup(
                    '<div class="popup-title">' + name + '</div>' +
                    '<div class="popup-row"><span class="popup-label">Type:</span><span class="popup-value">' + style.label + '</span></div>' +
                    (addr ? '<div class="popup-row"><span class="popup-label">Address:</span><span class="popup-value">' + addr.trim() + '</span></div>' : '') +
                    '<div class="popup-row"><span class="popup-label">Source:</span><span class="popup-value">OpenStreetMap</span></div>'
                );
            }
        }).addTo(infraLayer);
        document.getElementById('kpi-infra').textContent = count;
        showToast('Infrastructure loaded (' + count + ' facilities)', 'info');
    })
    .catch(function(err) { console.error('Infrastructure error:', err); });
