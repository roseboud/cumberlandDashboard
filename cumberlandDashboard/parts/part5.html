
// ---------- SIDEBAR LAYER TOGGLES ----------
document.getElementById('layer-flood').addEventListener('change', function(e) {
    if (e.target.checked) { map.addLayer(floodLayerFundy); map.addLayer(floodLayerNorth); }
    else { map.removeLayer(floodLayerFundy); map.removeLayer(floodLayerNorth); }
});
document.getElementById('layer-roads').addEventListener('change', function(e) {
    if (e.target.checked) map.addLayer(roadsLayer); else map.removeLayer(roadsLayer);
});
document.getElementById('layer-infra').addEventListener('change', function(e) {
    if (e.target.checked) map.addLayer(infraLayer); else map.removeLayer(infraLayer);
});
document.getElementById('layer-tides').addEventListener('change', function(e) {
    if (e.target.checked) map.addLayer(tideMarkersLayer); else map.removeLayer(tideMarkersLayer);
});

// ---------- FILE UPLOAD ----------
var uploadZone = document.getElementById('upload-zone');
var fileInput = document.getElementById('file-input');
var userLayersList = document.getElementById('user-layers-list');

uploadZone.addEventListener('click', function() { fileInput.click(); });
uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault(); uploadZone.classList.add('drag-over');
});
uploadZone.addEventListener('dragleave', function() {
    uploadZone.classList.remove('drag-over');
});
uploadZone.addEventListener('drop', function(e) {
    e.preventDefault(); uploadZone.classList.remove('drag-over');
    if (e.dataTransfer.files.length > 0) processUploadedFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) { processUploadedFile(e.target.files[0]); fileInput.value = ''; }
});

function processUploadedFile(file) {
    var fileName = file.name.toLowerCase();
    var reader = new FileReader();
    reader.onload = function(e) {
        var content = e.target.result;
        try {
            if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                addUserGeoJSONLayer(file.name, JSON.parse(content));
            } else if (fileName.endsWith('.csv')) {
                addUserCSVLayer(file.name, content);
            } else {
                showToast('Unsupported format: ' + fileName, 'error');
            }
        } catch (err) {
            showToast('Error parsing file: ' + err.message, 'error');
        }
    };
    reader.readAsText(file);
}

function addUserGeoJSONLayer(name, geoData) {
    var layerId = 'user-layer-' + (++userLayerCounter);
    var layer = L.geoJSON(geoData, {
        style: { fillColor: '#8b5cf6', fillOpacity: 0.3, color: '#6d28d9', weight: 2 },
        pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 6, fillColor: '#8b5cf6', color: '#6d28d9', weight: 2, fillOpacity: 0.7
            });
        },
        onEachFeature: function(feature, layer) {
            if (feature.properties) {
                var html = '<div class="popup-title">Custom Layer Feature</div>';
                for (var key in feature.properties) {
                    html += '<div class="popup-row"><span class="popup-label">' + key + ':</span><span class="popup-value">' + feature.properties[key] + '</span></div>';
                }
                layer.bindPopup(html);
            }
        }
    }).addTo(map);
    userLayers[layerId] = layer;
    addUserLayerUI(layerId, name);
    map.fitBounds(layer.getBounds(), { padding: [30, 30] });
    showToast('Layer loaded: ' + name, 'success');
}

function addUserCSVLayer(name, csvText) {
    var lines = csvText.trim().split('\n');
    if (lines.length < 2) { showToast('CSV file appears empty', 'error'); return; }
    var headers = lines[0].split(',').map(function(h) { return h.trim().toLowerCase(); });
    var latIdx = headers.findIndex(function(h) { return h === 'lat' || h === 'latitude'; });
    var lngIdx = headers.findIndex(function(h) { return h === 'lng' || h === 'lon' || h === 'long' || h === 'longitude'; });
    if (latIdx === -1 || lngIdx === -1) {
        showToast('CSV must have Lat and Lng columns', 'error'); return;
    }
    var layerId = 'user-layer-' + (++userLayerCounter);
    var layerGroup = L.layerGroup();
    var count = 0;
    for (var i = 1; i < lines.length; i++) {
        var cols = lines[i].split(',').map(function(c) { return c.trim(); });
        var lat = parseFloat(cols[latIdx]);
        var lng = parseFloat(cols[lngIdx]);
        if (!isNaN(lat) && !isNaN(lng)) {
            var marker = L.circleMarker([lat, lng], {
                radius: 5, fillColor: '#8b5cf6', color: '#6d28d9', weight: 2, fillOpacity: 0.7
            });
            var popupHtml = '<div class="popup-title">CSV Row ' + i + '</div>';
            headers.forEach(function(h, idx) {
                popupHtml += '<div class="popup-row"><span class="popup-label">' + h + ':</span><span class="popup-value">' + (cols[idx] || '') + '</span></div>';
            });
            marker.bindPopup(popupHtml);
            marker.addTo(layerGroup);
            count++;
        }
    }
    if (count === 0) { showToast('No valid coordinates in CSV', 'error'); return; }
    layerGroup.addTo(map);
    userLayers[layerId] = layerGroup;
    addUserLayerUI(layerId, name + ' (' + count + ' pts)');
    showToast('CSV loaded: ' + count + ' points', 'success');
}

function addUserLayerUI(layerId, name) {
    var item = document.createElement('div');
    item.className = 'user-layer-item';
    item.id = layerId + '-ui';
    item.innerHTML = '<span class="layer-name" title="' + name + '">' + name + '</span>' +
                     '<button class="remove-layer" data-layer-id="' + layerId + '">&times;</button>';
    userLayersList.appendChild(item);
    item.querySelector('.remove-layer').addEventListener('click', function() {
        var lid = this.getAttribute('data-layer-id');
        if (userLayers[lid]) { map.removeLayer(userLayers[lid]); delete userLayers[lid]; }
        var uiEl = document.getElementById(lid + '-ui');
        if (uiEl) uiEl.remove();
        showToast('Layer removed', 'info');
    });
}

// ---------- INITIAL FLOOD LOAD ----------
updateFloodDisplay(0);

console.log('Cumberland County Flood Dashboard initialized');
console.log('Tide stations: Saint John, Charlottetown, Caribou');
console.log('Flood data: FundySide + NorthSide (0-11m, 1m increments)');
console.log('Roads & Infrastructure: OpenStreetMap');

</script>
</body>
</html>
